<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invite Neighbors | Utah Pollinator Path</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-b from-green-50 to-amber-50 min-h-screen">
    <div class="max-w-lg mx-auto p-4 pb-24">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-green-800">ğŸ˜ï¸ Invite Neighbors</h1>
            <p class="text-gray-600">Connected habitats are more effective</p>
        </div>

        <!-- Why Invite -->
        <div class="bg-white rounded-xl shadow p-4 mb-4">
            <h2 class="font-semibold mb-2">Why invite neighbors?</h2>
            <ul class="text-sm text-gray-600 space-y-2">
                <li>ğŸ”— <strong>Connectivity matters:</strong> Pollinators need stepping stones across the landscape</li>
                <li>ğŸ“ˆ <strong>Boost your score:</strong> Each neighbor who joins adds to your connectivity points</li>
                <li>ğŸ… <strong>Earn badges:</strong> Get the "Pollinator Ambassador" badge when someone joins</li>
                <li>âš”ï¸ <strong>Win challenges:</strong> More neighbors = faster challenge completion</li>
            </ul>
        </div>

        <!-- Your Link -->
        <div id="inviteSection" class="bg-white rounded-xl shadow p-4 mb-4">
            <h2 class="font-semibold mb-3">Your Invite Link</h2>
            
            <div class="bg-gray-100 rounded-lg p-3 mb-3">
                <input type="text" id="inviteLink" readonly 
                    class="w-full bg-transparent text-sm text-gray-700 outline-none"
                    value="Loading...">
            </div>
            
            <div class="flex gap-2 mb-4">
                <button onclick="copyLink()" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-semibold">
                    ğŸ“‹ Copy Link
                </button>
                <button onclick="shareLink()" class="flex-1 border border-green-600 text-green-600 py-2 rounded-lg font-semibold">
                    ğŸ“¤ Share
                </button>
            </div>
            
            <div class="text-center">
                <p class="text-sm text-gray-500 mb-2">Or share your code:</p>
                <div class="text-3xl font-mono font-bold tracking-wider" id="inviteCode">----</div>
            </div>
        </div>

        <!-- Stats -->
        <div id="statsSection" class="bg-white rounded-xl shadow p-4 mb-4 hidden">
            <h2 class="font-semibold mb-3">Your Referral Stats</h2>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                    <div class="text-2xl font-bold text-green-600" id="joinedCount">0</div>
                    <div class="text-xs text-gray-500">Joined</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-amber-500" id="pendingCount">0</div>
                    <div class="text-xs text-gray-500">Pending</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-blue-500" id="pointsEarned">0</div>
                    <div class="text-xs text-gray-500">Points Earned</div>
                </div>
            </div>
        </div>

        <!-- Recent Referrals -->
        <div id="referralsList" class="bg-white rounded-xl shadow p-4 mb-4 hidden">
            <h2 class="font-semibold mb-3">Your Invites</h2>
            <div id="referralsContent" class="space-y-2"></div>
        </div>

        <!-- Not signed in -->
        <div id="signInPrompt" class="bg-amber-50 border border-amber-200 rounded-xl p-4 hidden text-center">
            <p class="text-amber-800 mb-2">Sign in to get your invite link</p>
            <a href="index.html" class="text-amber-600 font-semibold">Sign in â†’</a>
        </div>

        <!-- Top Recruiters -->
        <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold mb-3">ğŸ† Top Recruiters</h2>
            <div id="leaderboard" class="space-y-2">
                <div class="text-center text-gray-400 py-4">Loading...</div>
            </div>
        </div>
    </div>

    <script src="js/nav.js"></script>
    <script>
        const API = '';
        let token = localStorage.getItem('supabase_token');

        if (token) {
            loadMyCode();
            loadMyStats();
        } else {
            document.getElementById('inviteSection').classList.add('hidden');
            document.getElementById('signInPrompt').classList.remove('hidden');
        }
        
        loadLeaderboard();

        async function loadMyCode() {
            try {
                const res = await fetch(`${API}/api/referrals/code`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.code) {
                    document.getElementById('inviteLink').value = data.link;
                    document.getElementById('inviteCode').textContent = data.code;
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadMyStats() {
            try {
                const res = await fetch(`${API}/api/referrals/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                document.getElementById('statsSection').classList.remove('hidden');
                document.getElementById('joinedCount').textContent = data.joined_count || 0;
                document.getElementById('pendingCount').textContent = data.pending_count || 0;
                document.getElementById('pointsEarned').textContent = (data.joined_count || 0) * 3; // 3 pts per referral
                
                if (data.sent && data.sent.length > 0) {
                    document.getElementById('referralsList').classList.remove('hidden');
                    document.getElementById('referralsContent').innerHTML = data.sent.slice(0, 5).map(r => `
                        <div class="flex justify-between items-center py-2 border-b">
                            <div>
                                <span class="font-mono text-sm">${r.referral_code}</span>
                                ${r.referred_email ? `<span class="text-xs text-gray-400 ml-2">${r.referred_email}</span>` : ''}
                            </div>
                            <span class="text-xs px-2 py-1 rounded ${r.status === 'joined' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                                ${r.status}
                            </span>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadLeaderboard() {
            try {
                const res = await fetch(`${API}/api/referrals/leaderboard`);
                const data = await res.json();
                
                if (data.leaderboard?.length > 0) {
                    document.getElementById('leaderboard').innerHTML = data.leaderboard.map(r => `
                        <div class="flex justify-between items-center py-2">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${r.rank === 1 ? 'ğŸ¥‡' : r.rank === 2 ? 'ğŸ¥ˆ' : r.rank === 3 ? 'ğŸ¥‰' : r.rank}</span>
                                <span class="text-gray-600">Neighbor ${r.rank}</span>
                            </div>
                            <span class="font-bold">${r.count} invites</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('leaderboard').innerHTML = '<div class="text-center text-gray-400 py-4">Be the first to invite neighbors!</div>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function copyLink() {
            const link = document.getElementById('inviteLink');
            link.select();
            document.execCommand('copy');
            
            const btn = event.target;
            btn.textContent = 'âœ“ Copied!';
            setTimeout(() => btn.textContent = 'ğŸ“‹ Copy Link', 2000);
        }

        async function shareLink() {
            const link = document.getElementById('inviteLink').value;
            const text = `Join me in creating pollinator habitat! ğŸ¦‹ğŸŒ»`;
            
            if (navigator.share) {
                try {
                    await navigator.share({ title: 'Utah Pollinator Path', text, url: link });
                } catch (e) {}
            } else {
                copyLink();
            }
        }
    </script>
</body>
</html>
