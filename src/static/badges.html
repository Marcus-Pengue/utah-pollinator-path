<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badges | Utah Pollinator Path</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-b from-green-50 to-amber-50 min-h-screen">
    <div class="max-w-lg mx-auto p-4">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-green-800">ğŸ… Achievements</h1>
            <p class="text-gray-600">Earn badges for your pollinator work</p>
        </div>

        <div id="stats" class="bg-white rounded-xl shadow p-4 mb-4 hidden">
            <div class="flex justify-around text-center">
                <div>
                    <div class="text-3xl font-bold text-green-600" id="earnedCount">0</div>
                    <div class="text-xs text-gray-500">Earned</div>
                </div>
                <div>
                    <div class="text-3xl font-bold text-amber-600" id="totalPoints">0</div>
                    <div class="text-xs text-gray-500">Points</div>
                </div>
                <div>
                    <div class="text-3xl font-bold text-gray-400" id="availableCount">0</div>
                    <div class="text-xs text-gray-500">Available</div>
                </div>
            </div>
        </div>

        <button onclick="checkBadges()" id="checkBtn" class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold mb-4 hidden">
            ğŸ” Check for New Badges
        </button>

        <div id="myBadges" class="mb-6 hidden">
            <h2 class="font-semibold text-gray-700 mb-2">My Badges</h2>
            <div id="myBadgesList" class="grid grid-cols-3 gap-2"></div>
        </div>

        <div id="allBadges">
            <h2 class="font-semibold text-gray-700 mb-2">All Badges</h2>
            <div id="allBadgesList" class="space-y-2"></div>
        </div>

        
        <div class="h-16"></div>
    </div>

    <script>
        const API = '';
        let token = localStorage.getItem('supabase_token');
        let earnedKeys = new Set();

        loadAllBadges();
        if (token) { loadMyBadges(); document.getElementById('checkBtn').classList.remove('hidden'); }

        async function loadAllBadges() {
            const res = await fetch(`${API}/api/badges`);
            const data = await res.json();
            document.getElementById('availableCount').textContent = data.badges?.length || 0;
            
            const categories = {
                getting_started: "ğŸŒ± Getting Started", milkweed: "ğŸ¦‹ Milkweed Hero",
                seasonal: "ğŸ‚ Seasonal", diversity: "ğŸŒˆ Diversity",
                community: "ğŸ¤ Community", observations: "ğŸ”¬ Observations"
            };
            
            let html = '';
            for (const [cat, title] of Object.entries(categories)) {
                const badges = data.by_category?.[cat] || [];
                if (badges.length === 0) continue;
                html += `<div class="mb-4"><div class="text-sm font-medium text-gray-600 mb-2">${title}</div>
                    <div class="grid grid-cols-2 gap-2">${badges.map(b => `
                        <div class="bg-white rounded-lg p-3 border ${earnedKeys.has(b.key) ? 'border-green-500 bg-green-50' : 'border-gray-200 opacity-60'}">
                            <div class="flex items-center gap-2"><span class="text-2xl">${b.icon}</span>
                                <div><div class="font-medium text-sm">${b.name}</div><div class="text-xs text-gray-500">${b.points} pts</div></div>
                            </div><div class="text-xs text-gray-400 mt-1">${b.description}</div>
                        </div>`).join('')}</div></div>`;
            }
            document.getElementById('allBadgesList').innerHTML = html;
        }

        async function loadMyBadges() {
            const res = await fetch(`${API}/api/badges/my`, { headers: { 'Authorization': `Bearer ${token}` }});
            const data = await res.json();
            if (data.earned?.length > 0) {
                document.getElementById('stats').classList.remove('hidden');
                document.getElementById('myBadges').classList.remove('hidden');
                document.getElementById('earnedCount').textContent = data.count;
                document.getElementById('totalPoints').textContent = data.total_points;
                earnedKeys = new Set(data.earned.map(b => b.badge_key));
                document.getElementById('myBadgesList').innerHTML = data.earned.map(b => `
                    <div class="bg-white rounded-xl shadow p-3 text-center">
                        <div class="text-3xl mb-1">${b.icon || 'ğŸ…'}</div>
                        <div class="text-xs font-medium">${b.name || b.badge_key}</div>
                    </div>`).join('');
                loadAllBadges();
            } else { document.getElementById('stats').classList.remove('hidden'); }
        }

        async function checkBadges() {
            const res = await fetch(`${API}/api/badges/check`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }});
            const data = await res.json();
            if (data.new_badges?.length > 0) {
                alert(`ğŸ‰ You earned ${data.count} new badge(s)!\n\n${data.new_badges.map(b => `${b.icon} ${b.name}`).join('\n')}`);
                loadMyBadges();
            } else { alert('No new badges yet. Keep growing your garden!'); }
        }
    </script>
    <script src="js/nav.js"></script>
</body>
</html>
