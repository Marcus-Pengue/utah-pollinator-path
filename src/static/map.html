<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map | Utah Pollinator Path</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        .back-btn {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: white; border: none;
            width: 44px; height: 44px; border-radius: 50%;
            font-size: 1.3em; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .legend {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: white; padding: 12px 16px;
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 0.85em;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
    </style>
</head>
<body>
    <button class="back-btn" onclick="location.href='index.html'">←</button>
    <div id="map"></div>
    <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#FFD700;"></div><span>Pioneer (90%+)</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#90EE90;"></div><span>Champion (80%+)</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#87CEEB;"></div><span>Guardian (60%+)</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#D3D3D3;"></div><span>Seedling</span></div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = window.location.origin;
        const map = L.map('map').setView([40.6, -111.9], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        function getColor(level, score) {
            if (level === 'pioneer' || score >= 90) return '#FFD700';
            if (level === 'migration_champion' || score >= 80) return '#90EE90';
            if (level === 'habitat_guardian' || score >= 60) return '#87CEEB';
            return '#D3D3D3';
        }

        async function loadData() {
            try {
                const res = await fetch(`${API}/api/map/properties`);
                const geojson = await res.json();
                L.geoJSON(geojson, {
                    pointToLayer: (feature, latlng) => {
                        const p = feature.properties;
                        return L.circleMarker(latlng, {
                            radius: 8 + (p.observation_count || 0) * 2,
                            fillColor: getColor(p.identity_level, p.score),
                            color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.8
                        });
                    },
                    onEachFeature: (feature, layer) => {
                        const p = feature.properties;
                        layer.bindPopup(`
                            <b>${p.display_name || 'Anonymous'}</b><br>
                            Score: ${Math.round(p.score || 0)}% (${p.grade || 'N/A'})<br>
                            City: ${p.city || 'Unknown'}<br>
                            Observations: ${p.observation_count || 0}
                        `);
                    }
                }).addTo(map);
            } catch (err) {
                console.error(err);
            }
        }
        loadData();
    </script>
</body>
</html>
