<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ward Challenges | Utah Pollinator Path</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-b from-green-50 to-amber-50 min-h-screen">
    <div class="max-w-lg mx-auto p-4">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-green-800">‚öîÔ∏è Ward Challenges</h1>
            <p class="text-gray-600">Compete together, grow together</p>
        </div>

        <!-- My Challenges -->
        <div id="myChallenges" class="mb-6 hidden">
            <h2 class="font-semibold text-gray-700 mb-2">My Challenges</h2>
            <div id="myChallengesList" class="space-y-3"></div>
        </div>

        <!-- Active Challenges -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
                <h2 class="font-semibold text-gray-700">Active Challenges</h2>
                <button onclick="showCreateModal()" class="text-sm bg-green-600 text-white px-3 py-1 rounded-lg">
                    + Create
                </button>
            </div>
            <div id="challengesList" class="space-y-3">
                <div class="text-center text-gray-400 py-8">Loading challenges...</div>
            </div>
        </div>

        <!-- Templates Section -->
        <div class="mb-6">
            <h2 class="font-semibold text-gray-700 mb-2">Quick Start Templates</h2>
            <div id="templatesList" class="grid grid-cols-2 gap-2"></div>
        </div>

        <!-- Create Challenge Modal -->
        <div id="createModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-4 w-full max-w-md">
                <h3 class="font-bold text-lg mb-4">Create Challenge</h3>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Challenge Name</label>
                        <input type="text" id="challengeName" class="w-full border rounded-lg px-3 py-2" placeholder="September Ready Challenge">
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Description</label>
                        <textarea id="challengeDesc" class="w-full border rounded-lg px-3 py-2" rows="2" placeholder="What's this challenge about?"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Goal Type</label>
                            <select id="goalType" class="w-full border rounded-lg px-3 py-2">
                                <option value="fall_bloomers">Fall Bloomers</option>
                                <option value="milkweed">Milkweed Plants</option>
                                <option value="participants">Participants</option>
                                <option value="plants_added">Plants Added</option>
                                <option value="species_count">Species Variety</option>
                                <option value="observations">Observations</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Target</label>
                            <input type="number" id="goalTarget" class="w-full border rounded-lg px-3 py-2" value="10" min="1">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Ward (optional)</label>
                            <input type="text" id="challengeWard" class="w-full border rounded-lg px-3 py-2" placeholder="Murray 5th">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">City</label>
                            <input type="text" id="challengeCity" class="w-full border rounded-lg px-3 py-2" placeholder="Murray">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Duration (days)</label>
                        <input type="number" id="challengeDuration" class="w-full border rounded-lg px-3 py-2" value="30" min="7">
                    </div>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button onclick="hideCreateModal()" class="flex-1 border py-2 rounded-lg">Cancel</button>
                    <button onclick="createChallenge()" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-semibold">Create</button>
                </div>
            </div>
        </div>

        <!-- Challenge Detail Modal -->
        <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-4 w-full max-w-md max-h-[80vh] overflow-y-auto">
                <div id="detailContent"></div>
                <button onclick="hideDetailModal()" class="w-full mt-4 border py-2 rounded-lg">Close</button>
            </div>
        </div>

        <!-- Nav -->
        
        <div class="h-16"></div>
    </div>

    <script>
        const API = '';
        let token = localStorage.getItem('supabase_token');

        // Load on start
        loadChallenges();
        loadTemplates();
        if (token) loadMyChallenges();

        async function loadChallenges() {
            try {
                const res = await fetch(`${API}/api/challenges?status=active`);
                const data = await res.json();
                
                if (data.challenges?.length > 0) {
                    renderChallenges(data.challenges);
                } else {
                    document.getElementById('challengesList').innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <div class="text-4xl mb-2">üå±</div>
                            <div>No active challenges yet.</div>
                            <div class="text-sm">Create one for your ward!</div>
                        </div>`;
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderChallenges(challenges) {
            const html = challenges.map(c => `
                <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition" onclick="showDetail('${c.id}')">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-semibold">${c.name}</div>
                            <div class="text-sm text-gray-500">${c.ward || c.city || 'Open to all'}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold ${c.progress_pct >= 100 ? 'text-green-600' : 'text-amber-600'}">${c.progress_pct}%</div>
                            <div class="text-xs text-gray-400">${c.participant_count || 0} joined</div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">${c.description || ''}</div>
                    <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div class="bg-green-500 h-full transition-all" style="width: ${c.progress_pct}%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">${c.current_progress || 0} / ${c.goal_target} ${c.goal_type.replace('_', ' ')}</div>
                </div>
            `).join('');
            document.getElementById('challengesList').innerHTML = html;
        }

        async function loadMyChallenges() {
            try {
                const res = await fetch(`${API}/api/challenges/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.challenges?.length > 0) {
                    document.getElementById('myChallenges').classList.remove('hidden');
                    document.getElementById('myChallengesList').innerHTML = data.challenges.map(c => `
                        <div class="bg-green-50 border border-green-200 rounded-xl p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-medium">${c.name}</div>
                                    <div class="text-sm text-gray-500">Your contribution: ${c.my_contribution || 0}</div>
                                </div>
                                <div class="text-lg font-bold ${c.status === 'completed' ? 'text-green-600' : 'text-amber-600'}">
                                    ${c.progress_pct}%
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadTemplates() {
            try {
                const res = await fetch(`${API}/api/challenges/templates`);
                const data = await res.json();
                
                const icons = {
                    september_ready: 'üçÇ',
                    milkweed_mission: 'ü¶ã',
                    pollinator_block: 'üèòÔ∏è',
                    diversity_drive: 'üåà',
                    observation_blitz: 'üì∏'
                };
                
                document.getElementById('templatesList').innerHTML = Object.entries(data.templates).map(([key, t]) => `
                    <button onclick="createFromTemplate('${key}')" 
                        class="bg-white border rounded-lg p-3 text-left hover:border-green-500 transition">
                        <div class="text-2xl mb-1">${icons[key] || 'üéØ'}</div>
                        <div class="font-medium text-sm">${t.name}</div>
                        <div class="text-xs text-gray-500">Goal: ${t.goal_target} ${t.goal_type.replace('_', ' ')}</div>
                    </button>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        async function showDetail(id) {
            try {
                const res = await fetch(`${API}/api/challenges/${id}`);
                const c = await res.json();
                
                const isParticipant = c.participants?.some(p => p.user_id === getUserId());
                
                document.getElementById('detailContent').innerHTML = `
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">${c.status === 'completed' ? 'üéâ' : '‚öîÔ∏è'}</div>
                        <h3 class="font-bold text-xl">${c.name}</h3>
                        <div class="text-gray-500">${c.ward || c.city || 'Open to all'}</div>
                    </div>
                    
                    <div class="bg-gray-100 rounded-xl p-4 mb-4">
                        <div class="text-center">
                            <div class="text-4xl font-bold ${c.progress_pct >= 100 ? 'text-green-600' : 'text-amber-600'}">${c.progress_pct}%</div>
                            <div class="text-gray-600">${c.current_progress || 0} / ${c.goal_target} ${c.goal_type.replace('_', ' ')}</div>
                        </div>
                        <div class="bg-gray-300 rounded-full h-4 mt-3 overflow-hidden">
                            <div class="bg-green-500 h-full" style="width: ${c.progress_pct}%"></div>
                        </div>
                    </div>
                    
                    <p class="text-gray-600 mb-4">${c.description || ''}</p>
                    
                    ${c.ends_at ? `<div class="text-sm text-gray-500 mb-4">Ends: ${new Date(c.ends_at).toLocaleDateString()}</div>` : ''}
                    
                    <div class="mb-4">
                        <div class="font-semibold mb-2">Participants (${c.participant_count})</div>
                        <div class="space-y-1 max-h-32 overflow-y-auto">
                            ${c.participants?.slice(0, 10).map((p, i) => `
                                <div class="flex justify-between text-sm">
                                    <span>${i + 1}. Participant</span>
                                    <span class="font-medium">${p.contribution || 0}</span>
                                </div>
                            `).join('') || '<div class="text-gray-400 text-sm">No participants yet</div>'}
                        </div>
                    </div>
                    
                    ${token && !isParticipant ? `
                        <button onclick="joinChallenge('${c.id}')" class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold">
                            Join Challenge
                        </button>
                    ` : ''}
                    
                    ${token && isParticipant ? `
                        <button onclick="contribute('${c.id}')" class="w-full bg-amber-500 text-white py-3 rounded-xl font-semibold">
                            + Add Contribution
                        </button>
                    ` : ''}
                    
                    ${!token ? `
                        <div class="text-center text-gray-500">Sign in to participate</div>
                    ` : ''}
                `;
                
                document.getElementById('detailModal').classList.remove('hidden');
            } catch (e) {
                console.error(e);
            }
        }

        function hideDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function showCreateModal() {
            if (!token) {
                alert('Please sign in to create challenges');
                return;
            }
            document.getElementById('createModal').classList.remove('hidden');
        }

        function hideCreateModal() {
            document.getElementById('createModal').classList.add('hidden');
        }

        async function createFromTemplate(templateKey) {
            if (!token) {
                alert('Please sign in to create challenges');
                return;
            }
            
            const ward = prompt('What ward or neighborhood is this for? (optional)');
            const city = prompt('What city?') || 'Murray';
            
            try {
                const res = await fetch(`${API}/api/challenges`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ template: templateKey, ward, city })
                });
                
                if (res.ok) {
                    alert('Challenge created!');
                    loadChallenges();
                    loadMyChallenges();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to create');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function createChallenge() {
            const payload = {
                name: document.getElementById('challengeName').value,
                description: document.getElementById('challengeDesc').value,
                goal_type: document.getElementById('goalType').value,
                goal_target: parseInt(document.getElementById('goalTarget').value),
                ward: document.getElementById('challengeWard').value || null,
                city: document.getElementById('challengeCity').value || null,
                duration_days: parseInt(document.getElementById('challengeDuration').value),
            };
            
            if (!payload.name) {
                alert('Please enter a challenge name');
                return;
            }
            
            try {
                const res = await fetch(`${API}/api/challenges`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    hideCreateModal();
                    loadChallenges();
                    loadMyChallenges();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to create');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function joinChallenge(id) {
            try {
                const res = await fetch(`${API}/api/challenges/${id}/join`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    alert('Joined!');
                    hideDetailModal();
                    loadChallenges();
                    loadMyChallenges();
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function contribute(id) {
            const amount = parseInt(prompt('How many to contribute?', '1'));
            if (!amount || amount < 1) return;
            
            try {
                const res = await fetch(`${API}/api/challenges/${id}/contribute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ amount })
                });
                
                const data = await res.json();
                if (data.completed) {
                    alert('üéâ Challenge completed!');
                } else {
                    alert('Contribution recorded!');
                }
                
                hideDetailModal();
                loadChallenges();
                loadMyChallenges();
            } catch (e) {
                console.error(e);
            }
        }

        function getUserId() {
            // Decode JWT to get user ID (simplified)
            if (!token) return null;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.sub;
            } catch {
                return null;
            }
        }
    </script>
    <script src="js/nav.js"></script>
</body>
</html>
